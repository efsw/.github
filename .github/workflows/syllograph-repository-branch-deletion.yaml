on:
  workflow_call:
    inputs:
      organization_name:
        type: string
        required: true
      product_name:
        type: string
        required: true
      timezone:
        type: string
        required: false
        default: Europe/Rome
      region:
        type: string
        required: false
        default: us-east-1
    secrets:
      AWS_SYLLOGRAPH_ROLE_ARN:
        required: true
      EFSW_GITHUB_TOKEN:
        required: true

permissions:
  id-token: write
  contents: write

jobs:
  generate-resources-names:
    name: Computation of the names for all the resources generated by the workflow
    runs-on: ubuntu-18.04
    outputs:
      branch_type: ${{ steps.resource_names_generation.outputs.branch_type }}
      branch_name: ${{ steps.resource_names_generation.outputs.branch_name }}
      project_artifacts_bucket_name: ${{ steps.resource_names_generation.outputs.project_artifacts_bucket_name }}
      cloudformation_bucket_name: ${{ steps.resource_names_generation.outputs.cloudformation_bucket_name }}
      cloudformation_stack_name: ${{ steps.resource_names_generation.outputs.cloudformation_stack_name }}
      microservice_cloudformation_stack_lifecycle_artifact_name: ${{ steps.resource_names_generation.outputs.microservice_cloudformation_stack_lifecycle_artifact_name }}
      project_distribution_artifact_name: ${{ steps.resource_names_generation.outputs.project_distribution_artifact_name }}
    steps:
      - name: Cloning the repository
        uses: actions/checkout@v2
      - uses: actions/checkout@v2
        with:
          repository: efsw/syllograph
          ref: v1.1.0
          token: ${{ secrets.EFSW_GITHUB_TOKEN }}
          path: syllograph
      - id: resource_names_generation
        name: Computing the names of the resources
        uses: ./syllograph/.github/actions/syllograph-generate-resources-names
        with:
          efsw_github_token: ${{ secrets.EFSW_GITHUB_TOKEN }}
          organization_name: ${{ inputs.organization_name }}
          product_name: ${{ inputs.product_name }}
          timezone: ${{ inputs.timezone }}

  delete-cloudformation-stack:
    name: Deletion of the AWS Cloudformation stack
    runs-on: ubuntu-18.04
    needs: generate-resources-names
    steps:
      - name: Cloning the repository
        uses: actions/checkout@v2
      - uses: actions/checkout@v2
        with:
          repository: efsw/syllograph
          ref: v1.1.0
          token: ${{ secrets.EFSW_GITHUB_TOKEN }}
          path: syllograph
      - name: Setting up the AWS CLI
        uses: ./syllograph/.github/actions/syllograph-setup-aws-cli
        with:
          efsw_github_token: ${{ secrets.EFSW_GITHUB_TOKEN }}
          aws_role_arn: ${{ secrets.AWS_SYLLOGRAPH_ROLE_ARN }}
          aws_region: ${{ inputs.region }}
      - name: Deleting the CloudFormation stack
        run: aws cloudformation delete-stack --stack-name ${{ needs.generate-resources-names.outputs.cloudformation_stack_name }}
      - name: Emptying the artifacts S3 bucket
        run: aws s3 rm s3://${{ needs.generate-resources-names.outputs.project_artifacts_bucket_name }} --recursive
      - name: Deleting the artifacts S3 bucket
        run: aws s3 rb s3://${{ needs.generate-resources-names.outputs.project_artifacts_bucket_name }} --force
      - name: Emptying the CloudFormation template S3 bucket
        run: aws s3 rm s3://${{ needs.generate-resources-names.outputs.cloudformation_bucket_name }} --recursive
      - name: Deleting the CloudFormation template S3 bucket
        run: aws s3 rb s3://${{ needs.generate-resources-names.outputs.cloudformation_bucket_name }} --force
