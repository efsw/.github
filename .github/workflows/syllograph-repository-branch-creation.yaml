on:
  workflow_call:
    inputs:
      organization_name:
        type: string
        required: true
      product_name:
        type: string
        required: true
      skip_linting:
        type: boolean
        default: false
        required: false
      skip_testing:
        type: boolean
        default: false
        required: false
      skip_plugin:
        type: boolean
        default: false
        required: false
      skip_relay:
        type: boolean
        default: false
        required: false
      timezone:
        type: string
        default: Europe/Rome
        required: false
      region:
        type: string
        default: us-east-1
        required: false
    secrets:
      AWS_SYLLOGRAPH_ROLE_ARN:
        required: true
      SSH_PRIVATE_KEYS:
        required: true

permissions:
  id-token: write
  contents: write

jobs:
  generate-resources-names:
    name: Computation of the names for all the resources generated by the workflow
    runs-on: ubuntu-18.04
    if: always()
    outputs:
      plugin_name: ${{ steps.resource_names_generation.outputs.plugin_name }}
      branch_type: ${{ steps.resource_names_generation.outputs.branch_type }}
      branch_name: ${{ steps.resource_names_generation.outputs.branch_name }}
      environment_name: ${{ steps.resource_names_generation.outputs.environment_name }}
      plugin_target_reference_name: ${{ steps.resource_names_generation.outputs.plugin_target_reference_name }}
      project_artifacts_bucket_name: ${{ steps.resource_names_generation.outputs.project_artifacts_bucket_name }}
      cloudformation_bucket_name: ${{ steps.resource_names_generation.outputs.cloudformation_bucket_name }}
      cloudformation_stack_name: ${{ steps.resource_names_generation.outputs.cloudformation_stack_name }}
      microservice_cloudformation_stack_lifecycle_artifact_name: ${{ steps.resource_names_generation.outputs.microservice_cloudformation_stack_lifecycle_artifact_name }}
      project_distribution_artifact_name: ${{ steps.resource_names_generation.outputs.project_distribution_artifact_name }}
      distribution_name_hash: ${{ steps.resource_names_generation.outputs.distribution_name_hash }}
    steps:
      - name: Cloning the repository
        uses: actions/checkout@v3
      - uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEYS }}
      - uses: actions/checkout@v3
        with:
          repository: efsw/efsw.syllograph
          ref: v1.1.0
          path: syllograph
      - id: resource_names_generation
        name: Computing the names of the resources
        uses: ./syllograph/.github/actions/syllograph-generate-resources-names
        with:
          ssh_private_keys: ${{ secrets.SSH_PRIVATE_KEYS }}
          organization_name: ${{ inputs.organization_name }}
          product_name: ${{ inputs.product_name }}
          timezone: ${{ inputs.timezone }}

  deploy-cloudformation-stack:
    name: Deploying of the AWS Cloudformation stack
    runs-on: ubuntu-18.04
    needs: generate-resources-names
    if: always() && needs.generate-resources-names.result == 'success'
    steps:
      - name: Cloning the repository
        uses: actions/checkout@v3
      - uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEYS }}
      - uses: actions/checkout@v3
        with:
          repository: efsw/efsw.syllograph
          ref: v1.1.0
          path: syllograph
      - name: Setting up the AWS CLI
        uses: ./syllograph/.github/actions/syllograph-setup-aws-cli
        with:
          ssh_private_keys: ${{ secrets.SSH_PRIVATE_KEYS }}
          aws_role_arn: ${{ secrets.AWS_SYLLOGRAPH_ROLE_ARN }}
          aws_region: ${{ inputs.region }}
      - name: Deploying the CloudFormation templates
        uses: ./syllograph/.github/actions/syllograph-deploy-cloudformation-templates
        with:
          ssh_private_keys: ${{ secrets.SSH_PRIVATE_KEYS }}
          organization_name: ${{ inputs.organization_name }}
          product_name: ${{ inputs.product_name }}
          branch_name: ${{ needs.generate-resources-names.outputs.branch_name }}
          plugin_name: ${{ needs.generate-resources-names.outputs.plugin_name }}
          environment_name: ${{ needs.generate-resources-names.outputs.environment_name }}
          branch_type: ${{ needs.generate-resources-names.outputs.branch_type }}
          project_artifacts_bucket_name: ${{ needs.generate-resources-names.outputs.project_artifacts_bucket_name }}
          cloudformation_bucket_name: ${{ needs.generate-resources-names.outputs.cloudformation_bucket_name }}
          cloudformation_stack_name: ${{ needs.generate-resources-names.outputs.cloudformation_stack_name }}
          distribution_name_hash: ${{ needs.generate-resources-names.outputs.distribution_name_hash }}
  
  lint-project-sourcecode:
    name: Linting the source code of the project
    runs-on: ubuntu-18.04
    if: ${{ !inputs.skip_linting }}
    steps:
      - name: Cloning the repository
        uses: actions/checkout@v3
      - uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEYS }}
      - uses: actions/checkout@v3
        with:
          repository: efsw/efsw.syllograph
          ref: v1.1.0
          path: syllograph
      - name: Setting up the NodeJS environment
        uses: ./syllograph/.github/actions/syllograph-setup-node-environment
        with:
          ssh_private_keys: ${{ secrets.SSH_PRIVATE_KEYS }}
          efsw_npm_github_registry_token: ${{ secrets.EFSW_NPM_GITHUB_REGISTRY_TOKEN }}
      - name: Switching project plugin
        if: "inputs.skip_plugin != true"
        uses: ./syllograph/.github/actions/syllograph-switch-project-plugin
        with:
          ssh_private_keys: ${{ secrets.SSH_PRIVATE_KEYS }}
      - name: Linting the source code
        run: yarn run lint --max-warnings 1000 # TODO: refactor as a parameter

  test-project-sourcecode:
    name: Testing the source code of the project
    runs-on: ubuntu-18.04
    if: ${{ !inputs.skip_testing }}
    steps:
      - name: Cloning the repository
        uses: actions/checkout@v3
      - uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEYS }}
      - uses: actions/checkout@v3
        with:
          repository: efsw/efsw.syllograph
          ref: v1.1.0
          path: syllograph
      - name: Setting up the NodeJS environment
        uses: ./syllograph/.github/actions/syllograph-setup-node-environment
        with:
          ssh_private_keys: ${{ secrets.SSH_PRIVATE_KEYS }}
          efsw_npm_github_registry_token: ${{ secrets.EFSW_NPM_GITHUB_REGISTRY_TOKEN }}
      - name: Switching project plugin
        if: "inputs.skip_plugin != true"
        uses: ./syllograph/.github/actions/syllograph-switch-project-plugin
        with:
          ssh_private_keys: ${{ secrets.SSH_PRIVATE_KEYS }}
      - name: Testing the source code
        run: yarn run test --ci --passWithNoTests
  
  build-project-sourcecode:
    name: Building the source code of the project
    runs-on: ubuntu-18.04
    needs: [generate-resources-names, lint-project-sourcecode, test-project-sourcecode]
    if: |
      always() &&
      needs.generate-resources-names.result == 'success' &&
      (needs.lint-project-sourcecode.result == 'success' || needs.lint-project-sourcecode.result == 'skipped') &&
      (needs.test-project-sourcecode.result == 'success' || needs.test-project-sourcecode.result == 'skipped')
    steps:
      - name: Cloning the repository
        uses: actions/checkout@v3
      - uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEYS }}
      - uses: actions/checkout@v3
        with:
          repository: efsw/efsw.syllograph
          ref: v1.1.0
          path: syllograph
      - name: Building the source code of the project and uploading the artifacts
        uses: ./syllograph/.github/actions/syllograph-build-project
        with:
          ssh_private_keys: ${{ secrets.SSH_PRIVATE_KEYS }}
          efsw_npm_github_registry_token: ${{ secrets.EFSW_NPM_GITHUB_REGISTRY_TOKEN }}
          project_distribution_artifact_name: ${{ needs.generate-resources-names.outputs.project_distribution_artifact_name }}
          plugin_name: ${{ needs.generate-resources-names.outputs.plugin_name }}
          plugin_target_reference_name: ${{ needs.generate-resources-names.outputs.plugin_target_reference_name }}
          environment_name: ${{ needs.generate-resources-names.outputs.environment_name }}
          product_name: ${{ inputs.product_name }}
          skip_plugin: ${{ inputs.skip_plugin }}
          skip_relay: ${{ inputs.skip_relay }}

  upload-project-artifacts:
    name: Uploading the artifacts generated building the project
    runs-on: ubuntu-18.04
    needs: [generate-resources-names, build-project-sourcecode, deploy-cloudformation-stack]
    if: |
      always() &&
      needs.generate-resources-names.result == 'success' &&
      needs.build-project-sourcecode.result == 'success' &&
      needs.deploy-cloudformation-stack.result == 'success'
    steps:
      - name: Cloning the repository
        uses: actions/checkout@v3
      - uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEYS }}
      - uses: actions/checkout@v3
        with:
          repository: efsw/efsw.syllograph
          ref: v1.1.0
          path: syllograph
      - name: Downloading the generated artifacts of the project
        uses: actions/download-artifact@master
        with:
          name: ${{ needs.generate-resources-names.outputs.project_distribution_artifact_name }}
          path: build
      - name: Setting up the AWS CLI
        uses: ./syllograph/.github/actions/syllograph-setup-aws-cli
        with:
          ssh_private_keys: ${{ secrets.SSH_PRIVATE_KEYS }}
          aws_role_arn: ${{ secrets.AWS_SYLLOGRAPH_ROLE_ARN }}
          aws_region: ${{ inputs.region }}
      - name: Uploading the generated artifacts of the project
        run: aws s3 sync build s3://${{ needs.generate-resources-names.outputs.project_artifacts_bucket_name }}

  invalidate-cloudfront-distribution:
    name: Invalidating the cache of the CloudFront distribution
    needs: [generate-resources-names, upload-project-artifacts]
    if: |
      always() &&
      needs.generate-resources-names.result == 'success' &&
      needs.upload-project-artifacts.result == 'success'
    runs-on: ubuntu-18.04
    steps:
      - name: Cloning the repository
        uses: actions/checkout@v3
      - uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEYS }}
      - uses: actions/checkout@v3
        with:
          repository: efsw/efsw.syllograph
          ref: v1.1.0
          path: syllograph
      - name: Setting up the AWS CLI
        uses: ./syllograph/.github/actions/syllograph-setup-aws-cli
        with:
          ssh_private_keys: ${{ secrets.SSH_PRIVATE_KEYS }}
          aws_role_arn: ${{ secrets.AWS_SYLLOGRAPH_ROLE_ARN }}
          aws_region: ${{ inputs.region }}
      - name: Invalidating the CloudFront distribution
        uses: ./syllograph/.github/actions/syllograph-invalidate-cloudfront-distribution
        with:
          ssh_private_keys: ${{ secrets.SSH_PRIVATE_KEYS }}
          cloudformation_stack_name: ${{ needs.generate-resources-names.outputs.cloudformation_stack_name }}

  purging-artifacts:
    name: Purging the generated artifacts
    needs: [generate-resources-names, upload-project-artifacts]
    if: |
      always() &&
      needs.generate-resources-names.result == 'success' &&
      needs.upload-project-artifacts.result == 'success'
    runs-on: ubuntu-18.04
    steps:
      - name: Cloning the repository
        uses: actions/checkout@v3
      - uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEYS }}
      - uses: actions/checkout@v3
        with:
          repository: efsw/efsw.syllograph
          ref: v1.1.0
          path: syllograph
      - name: Purging the artifacts
        uses: ./syllograph/.github/actions/syllograph-purge-artifacts
        with:
          ssh_private_keys: ${{ secrets.SSH_PRIVATE_KEYS }}
          project_distribution_artifact_name: ${{ needs.generate-resources-names.outputs.project_distribution_artifact_name }}
